<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>NotaF√°cil</title>

<!-- PWA -->
<meta name="application-name" content="NotaF√°cil">
<meta name="description" content="Presta√ß√£o de contas para viagens corporativas">
<meta name="theme-color" content="#1a1a1a">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="NotaF√°cil">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-512.png">
<link rel="icon" sizes="192x192" href="icon-192.png">

<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<style>
:root {
  --bg: #f4f1ea;
  --surf: #ffffff;
  --surf2: #eae6de;
  --bdr: #d6d0c4;
  --acc: #1a1a1a;
  --green: #2d6a4f;
  --green-l: #d8f3dc;
  --red: #c1121f;
  --red-l: #ffe5e5;
  --amber: #d4700a;
  --amber-l: #fff3cd;
  --blue: #1d4e89;
  --blue-l: #dbeafe;
  --txt: #1a1a1a;
  --muted: #7a7065;
  --flash: #d4700a;
  --dep: #1d4e89;
}
* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--txt); max-width: 430px; margin: 0 auto; min-height: 100vh; }

/* NAV */
.nav { display: flex; background: var(--acc); position: sticky; top: 0; z-index: 200; }
.nav-t { flex: 1; padding: 13px 2px; text-align: center; font-size: 10px; font-weight: 600; letter-spacing: 0.3px; color: rgba(255,255,255,0.4); cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; text-transform: uppercase; }
.nav-t.on { color: #fff; border-bottom-color: var(--bg); }

/* SCREENS */
.screen { display: none; padding-bottom: 110px; }
.screen.on { display: block; }

/* PAGE HEADER */
.ph { padding: 16px 16px 12px; background: var(--acc); color: white; }
.ph-title { font-family: 'Bebas Neue', sans-serif; font-size: 28px; letter-spacing: 0.5px; line-height: 1; }
.ph-sub { font-size: 10px; opacity: 0.5; text-transform: uppercase; letter-spacing: 1px; margin-top: 2px; }

/* BALANCE */
.bal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 14px 14px 0; }
.bal-card { background: var(--surf); border-radius: 14px; padding: 13px; border: 1px solid var(--bdr); }
.bal-lbl { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: var(--muted); margin-bottom: 3px; }
.bal-val { font-family: 'Bebas Neue', sans-serif; font-size: 24px; }
.bal-sub { font-size: 10px; color: var(--muted); margin-top: 3px; font-family: 'DM Mono', monospace; line-height: 1.5; }
.pos { color: var(--green); } .neg { color: var(--red); }

.tot-card { margin: 10px 14px 0; background: var(--acc); color: white; border-radius: 14px; padding: 13px 16px; display: flex; justify-content: space-between; align-items: center; }
.tot-card .bal-lbl { color: rgba(255,255,255,0.5); }
.tot-card .bal-val { font-size: 28px; color: white; }
.tot-badge { font-size: 11px; background: rgba(255,255,255,0.1); border-radius: 20px; padding: 4px 10px; color: rgba(255,255,255,0.7); }

/* CAT SCROLL */
.cs { display: flex; gap: 8px; padding: 12px 14px; overflow-x: auto; scrollbar-width: none; }
.cs::-webkit-scrollbar { display: none; }
.cpill { flex-shrink: 0; display: flex; align-items: center; gap: 5px; padding: 5px 11px; border-radius: 20px; font-size: 11px; font-weight: 500; border: 1px solid var(--bdr); background: var(--surf); white-space: nowrap; }
.cdot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }

/* SECTION LABEL */
.sl { font-size: 10px; text-transform: uppercase; letter-spacing: 2px; color: var(--muted); padding: 6px 14px 4px; }

/* EXPENSE LIST */
.el { padding: 0 10px; }
.ecard { background: var(--surf); border: 1px solid var(--bdr); border-radius: 12px; margin-bottom: 8px; display: flex; align-items: stretch; overflow: hidden; transition: transform 0.15s; }
.ecard:active { transform: scale(0.98); }
.estripe { width: 4px; flex-shrink: 0; }
.ebody { padding: 11px 11px 9px; flex: 1; min-width: 0; }
.etop { display: flex; justify-content: space-between; align-items: flex-start; gap: 8px; }
.ename { font-weight: 600; font-size: 13px; line-height: 1.2; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.eval { font-family: 'DM Mono', monospace; font-weight: 500; font-size: 13px; flex-shrink: 0; }
.emeta { display: flex; gap: 5px; margin-top: 5px; flex-wrap: wrap; align-items: center; }
.mtag { font-size: 10px; padding: 2px 6px; border-radius: 8px; border: 1px solid var(--bdr); color: var(--muted); font-family: 'DM Mono', monospace; }
.mcat { border: none !important; font-family: 'DM Sans', sans-serif; font-weight: 500; }
.edel { background: none; border: 1px solid var(--bdr); color: var(--muted); border-radius: 6px; padding: 4px 8px; cursor: pointer; font-size: 11px; align-self: center; margin-right: 8px; flex-shrink: 0; }
.edel:hover { border-color: var(--red); color: var(--red); }
.ethumb { width: 38px; height: 38px; border-radius: 6px; object-fit: cover; flex-shrink: 0; align-self: center; margin-right: 6px; border: 1px solid var(--bdr); cursor: pointer; }

/* DEPOSIT ITEM */
.ditem { background: var(--surf); border: 1px solid var(--bdr); border-radius: 12px; margin-bottom: 8px; padding: 12px 14px; display: flex; justify-content: space-between; align-items: center; }
.ditem-l { flex: 1; }
.ditem-tipo { font-size: 11px; font-weight: 600; margin-bottom: 2px; }
.ditem-data { font-size: 11px; color: var(--muted); font-family: 'DM Mono', monospace; }
.ditem-val { font-family: 'Bebas Neue', sans-serif; font-size: 22px; flex-shrink: 0; }
.ditem-del { background: none; border: 1px solid var(--bdr); color: var(--muted); border-radius: 6px; padding: 4px 8px; cursor: pointer; font-size: 11px; margin-left: 10px; }

/* DEPOSIT SUMMARY */
.dsumm { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 14px 14px 0; }

/* EMPTY */
.empty { text-align: center; padding: 50px 20px; color: var(--muted); }
.empty-i { font-size: 40px; margin-bottom: 10px; opacity: 0.4; }

/* FAB */
.fab { position: fixed; bottom: 18px; left: 50%; transform: translateX(-50%); display: flex; gap: 8px; z-index: 300; }
.fab-main { background: var(--acc); color: white; border: none; border-radius: 50px; padding: 14px 22px; font-family: 'DM Sans', sans-serif; font-weight: 600; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 7px; box-shadow: 0 6px 24px rgba(0,0,0,0.25); transition: all 0.15s; white-space: nowrap; }
.fab-main:active { transform: scale(0.95); box-shadow: none; }
.fab-sec { background: var(--surf); color: var(--txt); border: 1px solid var(--bdr); border-radius: 50px; padding: 14px 16px; font-family: 'DM Sans', sans-serif; font-weight: 600; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 6px; box-shadow: 0 4px 16px rgba(0,0,0,0.1); transition: all 0.15s; white-space: nowrap; }
.fab-sec:active { transform: scale(0.95); }

/* OVERLAY/DRAWER */
.overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 400; display: flex; align-items: flex-end; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
.overlay.on { opacity: 1; pointer-events: all; }
.drawer { background: var(--bg); border-radius: 20px 20px 0 0; width: 100%; padding: 0 0 40px; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.32,1.2,0.6,1); max-height: 92vh; overflow-y: auto; border-top: 1px solid var(--bdr); }
.overlay.on .drawer { transform: translateY(0); }
.dhandle { width: 36px; height: 4px; background: var(--bdr); border-radius: 2px; margin: 12px auto 0; }
.dhead { padding: 14px 18px 11px; border-bottom: 1px solid var(--bdr); }
.dtitle { font-family: 'Bebas Neue', sans-serif; font-size: 22px; letter-spacing: 0.5px; }
.dbody { padding: 14px 18px; }

/* FORM */
.fg { margin-bottom: 13px; }
.flbl { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: var(--muted); display: block; margin-bottom: 5px; font-weight: 600; }
.finp { width: 100%; background: var(--surf); border: 1.5px solid var(--bdr); border-radius: 10px; padding: 11px 13px; color: var(--txt); font-family: 'DM Sans', sans-serif; font-size: 14px; outline: none; transition: border-color 0.2s; }
.finp:focus { border-color: var(--acc); }
.frow { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.fta { width: 100%; background: var(--surf); border: 1.5px solid var(--bdr); border-radius: 10px; padding: 11px 13px; color: var(--txt); font-family: 'DM Sans', sans-serif; font-size: 14px; outline: none; resize: none; min-height: 65px; transition: border-color 0.2s; }
.fta:focus { border-color: var(--acc); }

/* CAMERA */
.cam-area { border: 2px dashed var(--bdr); border-radius: 12px; aspect-ratio: 4/3; background: var(--surf2); display: flex; align-items: center; justify-content: center; overflow: hidden; margin-bottom: 10px; cursor: pointer; position: relative; }
.cam-area img { width: 100%; height: 100%; object-fit: cover; display: none; position: absolute; inset: 0; }
.cam-ph { text-align: center; color: var(--muted); z-index: 1; }
.cam-ph .ci { font-size: 34px; margin-bottom: 6px; }
.cam-ph p { font-size: 12px; }
#fileInput { display: none; }
.cam-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 13px; }
.cam-btn { background: var(--surf2); border: 1px solid var(--bdr); border-radius: 10px; padding: 10px; font-family: 'DM Sans', sans-serif; font-size: 12px; font-weight: 500; cursor: pointer; color: var(--txt); transition: all 0.15s; }
.cam-btn:active { transform: scale(0.97); }

/* AI STATUS BAR */
.ai-bar { background: var(--surf); border: 1.5px solid var(--bdr); border-radius: 10px; padding: 10px 13px; font-size: 12px; color: var(--muted); display: flex; align-items: center; gap: 8px; margin-bottom: 13px; min-height: 42px; transition: all 0.2s; }
.ai-bar.ld { border-color: var(--amber); color: var(--amber); background: var(--amber-l); }
.ai-bar.ok { border-color: var(--green); color: var(--green); background: var(--green-l); }
.ai-bar.er { border-color: var(--red); color: var(--red); background: var(--red-l); }
.spin { width: 13px; height: 13px; border: 2px solid currentColor; border-top-color: transparent; border-radius: 50%; animation: spin 0.7s linear infinite; flex-shrink: 0; }
@keyframes spin { to { transform: rotate(360deg); } }

/* CAT GRID */
.cat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.cat-opt { border: 1.5px solid var(--bdr); border-radius: 10px; padding: 9px 11px; cursor: pointer; font-size: 12px; font-weight: 500; display: flex; align-items: center; gap: 6px; transition: all 0.15s; background: var(--surf); }
.cat-opt.on { border-color: var(--acc); background: var(--acc); color: white; }
.cat-opt.on .cdot { background: white !important; }
.cat-add { border: 1.5px dashed var(--bdr); border-radius: 10px; padding: 9px 11px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 6px; color: var(--muted); background: var(--surf); transition: all 0.15s; }

/* PAY GRID */
.pay-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.pay-opt { border: 1.5px solid var(--bdr); border-radius: 10px; padding: 10px 11px; cursor: pointer; font-size: 12px; font-weight: 500; text-align: center; transition: all 0.15s; background: var(--surf); }
.pay-opt.on-flash { border-color: var(--flash); background: var(--amber-l); color: var(--flash); }
.pay-opt.on-dep { border-color: var(--dep); background: var(--blue-l); color: var(--dep); }

/* SAVE BTN */
.btn-save { background: var(--acc); color: white; border: none; border-radius: 12px; padding: 14px; font-family: 'DM Sans', sans-serif; font-weight: 600; font-size: 15px; cursor: pointer; width: 100%; margin-top: 8px; transition: all 0.15s; }
.btn-save:disabled { opacity: 0.3; cursor: not-allowed; }
.btn-save:not(:disabled):active { transform: scale(0.98); }

/* SETTINGS */
.ss { padding: 14px; }
.sc { background: var(--surf); border: 1px solid var(--bdr); border-radius: 14px; margin-bottom: 12px; overflow: hidden; }
.sch { padding: 13px 15px; border-bottom: 1px solid var(--bdr); font-weight: 600; font-size: 13px; display: flex; justify-content: space-between; align-items: center; }
.scb { padding: 13px 15px; }
.srow { display: flex; justify-content: space-between; align-items: center; padding: 9px 0; border-bottom: 1px solid var(--bdr); }
.srow:last-child { border-bottom: none; }
.srow-lbl { font-size: 13px; }
.srow-val { font-family: 'DM Mono', monospace; font-size: 13px; color: var(--muted); }
.btn-sm { background: var(--acc); color: white; border: none; border-radius: 8px; padding: 7px 12px; font-family: 'DM Sans', sans-serif; font-size: 12px; font-weight: 600; cursor: pointer; white-space: nowrap; }
.add-cat-row { display: flex; gap: 8px; margin-top: 10px; }
.add-cat-inp { flex: 1; background: var(--surf2); border: 1px solid var(--bdr); border-radius: 8px; padding: 8px 10px; font-family: 'DM Sans', sans-serif; font-size: 13px; color: var(--txt); outline: none; }
.add-cat-inp:focus { border-color: var(--acc); }
.cat-mgr-item { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid var(--bdr); }
.cat-mgr-item:last-child { border-bottom: none; }
.col-pick { width: 22px; height: 22px; border-radius: 50%; border: none; cursor: pointer; padding: 0; flex-shrink: 0; }
.cat-mgr-name { flex: 1; font-size: 13px; font-weight: 500; }
.cat-mgr-del { background: none; border: none; cursor: pointer; color: var(--muted); font-size: 16px; padding: 4px; }

/* TOGGLE */
.toggle { position: relative; width: 40px; height: 22px; flex-shrink: 0; }
.toggle input { opacity: 0; width: 0; height: 0; }
.tslider { position: absolute; inset: 0; background: var(--bdr); border-radius: 11px; cursor: pointer; transition: 0.2s; }
.tslider:before { content: ''; position: absolute; width: 16px; height: 16px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: 0.2s; }
.toggle input:checked + .tslider { background: var(--green); }
.toggle input:checked + .tslider:before { transform: translateX(18px); }

/* NOTIF BANNER */
.notif-banner { margin: 10px 14px 0; background: var(--amber-l); border: 1px solid var(--amber); border-radius: 12px; padding: 11px 13px; font-size: 12px; color: var(--amber); display: none; align-items: center; gap: 8px; }
.notif-banner.on { display: flex; }
.notif-x { margin-left: auto; background: none; border: none; cursor: pointer; color: var(--amber); font-size: 16px; }

/* TOAST */
.toast { position: fixed; bottom: 88px; left: 50%; transform: translateX(-50%) translateY(10px); background: var(--acc); color: white; border-radius: 50px; padding: 10px 20px; font-size: 13px; opacity: 0; transition: all 0.25s; pointer-events: none; z-index: 999; white-space: nowrap; font-weight: 500; }
.toast.on { opacity: 1; transform: translateX(-50%) translateY(0); }
.toast.g { background: var(--green); }
.toast.r { background: var(--red); }

/* IMAGE VIEWER */
.img-viewer { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 500; display: none; align-items: center; justify-content: center; }
.img-viewer.on { display: flex; }
.img-viewer img { max-width: 95vw; max-height: 90vh; border-radius: 8px; }
.img-viewer-close { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); border: none; color: white; font-size: 24px; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }
</style>
</head>
<body>

<!-- NAV -->
<div class="nav">
  <div class="nav-t on"  onclick="goTo('home')">üè† In√≠cio</div>
  <div class="nav-t"     onclick="goTo('expenses')">üßæ Notas</div>
  <div class="nav-t"     onclick="goTo('deposits')">üí∞ Adiant.</div>
  <div class="nav-t"     onclick="goTo('settings')">‚öôÔ∏è Config</div>
</div>

<!-- HOME -->
<div class="screen on" id="screen-home">
  <div class="ph"><div class="ph-title">NotaF√°cil</div><div class="ph-sub">Presta√ß√£o de Contas</div></div>
  <div id="notifBanner" class="notif-banner">üîî <span id="notifTxt"></span><button class="notif-x" onclick="closeNotif()">‚úï</button></div>
  <div class="bal-grid">
    <div class="bal-card"><div class="bal-lbl">üí≥ Cart√£o Flash</div><div class="bal-val" id="balFlash">R$ 0</div><div class="bal-sub" id="subFlash">‚Äî</div></div>
    <div class="bal-card"><div class="bal-lbl">üè¶ Dep√≥sito</div><div class="bal-val" id="balDep">R$ 0</div><div class="bal-sub" id="subDep">‚Äî</div></div>
  </div>
  <div class="tot-card">
    <div><div class="bal-lbl">Total gasto</div><div class="bal-val" id="totSpent">R$ 0,00</div></div>
    <div class="tot-badge" id="totBadge">0 notas</div>
  </div>
  <div class="cs" id="catScroll"></div>
  <div class="sl">√öltimas despesas</div>
  <div class="el" id="homeList"></div>
</div>

<!-- NOTAS -->
<div class="screen" id="screen-expenses">
  <div class="ph"><div class="ph-title">Todas as Notas</div></div>
  <div class="el" style="padding-top:10px" id="allList"></div>
</div>

<!-- ADIANTAMENTOS -->
<div class="screen" id="screen-deposits">
  <div class="ph"><div class="ph-title">Adiantamentos</div><div class="ph-sub">Valores recebidos da empresa</div></div>
  <div class="dsumm">
    <div class="bal-card"><div class="bal-lbl">üí≥ Total Flash</div><div class="bal-val pos" id="dSumFlash">R$ 0</div></div>
    <div class="bal-card"><div class="bal-lbl">üè¶ Total Dep.</div><div class="bal-val pos" id="dSumDep">R$ 0</div></div>
  </div>
  <div class="sl" style="margin-top:10px">Hist√≥rico</div>
  <div class="el" id="depList"></div>
</div>

<!-- CONFIGURA√á√ïES -->
<div class="screen" id="screen-settings">
  <div class="ph"><div class="ph-title">Configura√ß√µes</div></div>
  <div class="ss">

    <!-- GEMINI KEY -->
    <div class="sc">
      <div class="sch">üîë Chave Gemini (IA ‚Äî Gratuita)</div>
      <div class="scb">
        <p style="font-size:12px;color:var(--muted);margin-bottom:10px;line-height:1.6">
          Necess√°ria para ler notas automaticamente.<br>
          Obtenha <strong>gr√°tis</strong> em <strong>aistudio.google.com</strong><br>
          ‚Üí clique em <em>"Get API Key"</em>
        </p>
        <div style="display:flex;gap:8px">
          <input type="password" id="geminiInput" class="finp" placeholder="AIzaSy..." style="font-family:monospace;font-size:12px">
          <button class="btn-sm" onclick="saveGeminiKey()">Salvar</button>
        </div>
        <div id="geminiStatus" style="font-size:11px;margin-top:6px;color:var(--muted)"></div>
      </div>
    </div>

    <!-- NOTIFICA√á√ïES -->
    <div class="sc">
      <div class="sch">üîî Lembretes de Refei√ß√£o</div>
      <div class="scb">
        <div class="srow"><div class="srow-lbl">Lembretes ativos</div>
          <label class="toggle"><input type="checkbox" id="notifToggle" checked onchange="saveSettings()"><span class="tslider"></span></label>
        </div>
        <div class="srow"><div class="srow-lbl">üçΩ Almo√ßo</div><div class="srow-val">12:00</div></div>
        <div class="srow"><div class="srow-lbl">üåô Janta</div><div class="srow-val">19:00</div></div>
        <button class="btn-sm" style="margin-top:10px" onclick="testNotif()">Testar notifica√ß√£o</button>
      </div>
    </div>

    <!-- CATEGORIAS -->
    <div class="sc">
      <div class="sch">üè∑ Categorias</div>
      <div class="scb" id="catMgrList"></div>
      <div style="padding:0 15px 14px">
        <div class="add-cat-row">
          <input class="add-cat-inp" id="newCatInp" placeholder="Nova categoria..." onkeydown="if(event.key==='Enter')addCat()">
          <button class="btn-sm" onclick="addCat()">+ Adicionar</button>
        </div>
      </div>
    </div>

    <!-- EXPORTAR -->
    <div class="sc">
      <div class="sch">üìä Exportar Relat√≥rio</div>
      <div class="scb" style="display:flex;flex-direction:column;gap:8px">
        <button class="btn-save" style="margin-top:0" onclick="exportExcel()">‚¨á Excel (planilha completa)</button>
        <button class="btn-save" style="margin-top:0;background:var(--blue)" onclick="exportZip()">üóú ZIP (Excel + fotos das notas)</button>
        <p style="font-size:11px;color:var(--muted);text-align:center">O ZIP inclui a planilha + todas as fotos das notas nomeadas</p>
      </div>
    </div>

    <!-- PERIGO -->
    <div class="sc">
      <div class="sch" style="color:var(--red)">‚ö†Ô∏è Zona de Risco</div>
      <div class="scb" style="display:flex;flex-direction:column;gap:8px">
        <button onclick="clearExp()" style="background:var(--red-l);color:var(--red);border:1px solid var(--red);border-radius:10px;padding:10px;font-family:'DM Sans',sans-serif;font-size:13px;cursor:pointer;font-weight:600">üóë Apagar todas as notas</button>
        <button onclick="clearDep()" style="background:var(--red-l);color:var(--red);border:1px solid var(--red);border-radius:10px;padding:10px;font-family:'DM Sans',sans-serif;font-size:13px;cursor:pointer;font-weight:600">üóë Apagar todos os adiantamentos</button>
      </div>
    </div>

  </div>
</div>

<!-- FAB -->
<div class="fab" id="fab">
  <button class="fab-main" id="fabBtn" onclick="openAddModal()">üì∑ Nova Nota</button>
  <button class="fab-sec" id="fabSec" onclick="exportExcel()">‚¨á Excel</button>
</div>

<!-- MODAL: NOVA NOTA -->
<div class="overlay" id="addOverlay" onclick="if(event.target===this)closeAdd()">
  <div class="drawer">
    <div class="dhandle"></div>
    <div class="dhead"><div class="dtitle">üì∑ Nova Despesa</div></div>
    <div class="dbody">
      <div class="cam-area" id="camArea" onclick="triggerCam()">
        <div class="cam-ph" id="camPH"><div class="ci">üì∏</div><p>Toque para fotografar a nota</p></div>
        <img id="prevImg" alt="preview">
      </div>
      <input type="file" id="fileInput" accept="image/*" onchange="handleFile(event)">
      <div class="cam-btns">
        <button class="cam-btn" onclick="triggerCam()">üì∑ C√¢mera</button>
        <button class="cam-btn" onclick="triggerGallery()">üñº Galeria</button>
      </div>
      <div class="ai-bar" id="aiBar">‚ú® Fotografe a nota para preencher automaticamente</div>
      <div class="fg"><label class="flbl">Estabelecimento / Descri√ß√£o</label><input type="text" class="finp" id="fNome" placeholder="Ex: Restaurante Central"></div>
      <div class="frow">
        <div class="fg"><label class="flbl">Valor (R$)</label><input type="number" class="finp" id="fValor" placeholder="0,00" step="0.01" min="0"></div>
        <div class="fg"><label class="flbl">Data</label><input type="date" class="finp" id="fData"></div>
      </div>
      <div class="fg"><label class="flbl">Categoria</label><div class="cat-grid" id="catGrid"></div></div>
      <div class="fg">
        <label class="flbl">Forma de Pagamento</label>
        <div class="pay-grid">
          <div class="pay-opt" data-pay="Flash" onclick="selPay(this)">üí≥ Cart√£o Flash</div>
          <div class="pay-opt" data-pay="Dep√≥sito" onclick="selPay(this)">üè¶ Dep√≥sito</div>
        </div>
      </div>
      <div class="fg"><label class="flbl">Observa√ß√£o (opcional)</label><textarea class="fta" id="fObs" placeholder="Ex: reuni√£o com cliente..."></textarea></div>
      <button class="btn-save" onclick="saveExp()">‚úì Salvar Despesa</button>
    </div>
  </div>
</div>

<!-- MODAL: NOVO ADIANTAMENTO -->
<div class="overlay" id="depOverlay" onclick="if(event.target===this)closeDep()">
  <div class="drawer">
    <div class="dhandle"></div>
    <div class="dhead"><div class="dtitle">üí∞ Novo Adiantamento</div></div>
    <div class="dbody">
      <div class="fg">
        <label class="flbl">Tipo</label>
        <div class="pay-grid">
          <div class="pay-opt" data-pay="Flash" onclick="selDepTipo(this)">üí≥ Cart√£o Flash</div>
          <div class="pay-opt" data-pay="Dep√≥sito" onclick="selDepTipo(this)">üè¶ Dep√≥sito em Conta</div>
        </div>
      </div>
      <div class="frow">
        <div class="fg"><label class="flbl">Valor (R$)</label><input type="number" class="finp" id="dValor" placeholder="0,00" step="0.01" min="0"></div>
        <div class="fg"><label class="flbl">Data</label><input type="date" class="finp" id="dData"></div>
      </div>
      <div class="fg"><label class="flbl">Observa√ß√£o (opcional)</label><input type="text" class="finp" id="dObs" placeholder="Ex: adiantamento ter√ßa"></div>
      <button class="btn-save" onclick="saveDep()">‚úì Registrar Adiantamento</button>
    </div>
  </div>
</div>

<!-- IMAGE VIEWER -->
<div class="img-viewer" id="imgViewer" onclick="closeViewer()">
  <button class="img-viewer-close" onclick="closeViewer()">‚úï</button>
  <img id="viewerImg" alt="nota">
</div>

<div class="toast" id="toast"></div>

<script>
// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let expenses  = [];
let deposits  = [];
let categories = [];
let settings  = {};
let selCat    = '';
let selPay_   = '';
let selDepT   = '';
let curB64    = '';
let aiRunning = false;
let curScreen = 'home';

const DEF_CATS = [
  { name:'Alimenta√ß√£o', color:'#e07d10' },
  { name:'Transporte',  color:'#1d4e89' },
  { name:'Lavanderia',  color:'#7b2d8b' },
  { name:'Outros',      color:'#2d6a4f' },
];

function load() {
  try { expenses   = JSON.parse(localStorage.getItem('nf_exp')  || '[]'); }    catch(e){ expenses=[]; }
  try { deposits   = JSON.parse(localStorage.getItem('nf_dep')  || '[]'); }    catch(e){ deposits=[]; }
  try { categories = JSON.parse(localStorage.getItem('nf_cats') || 'null') || DEF_CATS.map(c=>({...c})); } catch(e){ categories=DEF_CATS.map(c=>({...c})); }
  try { settings   = JSON.parse(localStorage.getItem('nf_set')  || '{}'); }    catch(e){ settings={}; }
}
function save() {
  localStorage.setItem('nf_exp',  JSON.stringify(expenses));
  localStorage.setItem('nf_dep',  JSON.stringify(deposits));
  localStorage.setItem('nf_cats', JSON.stringify(categories));
  localStorage.setItem('nf_set',  JSON.stringify(settings));
}
const getGeminiKey = () => localStorage.getItem('nf_gemini') || '';

// ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function goTo(id) {
  curScreen = id;
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('on'));
  document.querySelectorAll('.nav-t').forEach(t => t.classList.remove('on'));
  document.getElementById('screen-' + id).classList.add('on');
  const idx = ['home','expenses','deposits','settings'].indexOf(id);
  document.querySelectorAll('.nav-t')[idx].classList.add('on');

  const fab    = document.getElementById('fab');
  const fabBtn = document.getElementById('fabBtn');
  const fabSec = document.getElementById('fabSec');

  if (id === 'settings') {
    fab.style.display = 'none';
    renderSettings();
  } else if (id === 'deposits') {
    fab.style.display = 'flex';
    fabBtn.textContent = '+ Adiantamento';
    fabBtn.onclick = openDepModal;
    fabSec.style.display = 'none';
    renderDeposits();
  } else {
    fab.style.display = 'flex';
    fabBtn.innerHTML = 'üì∑ Nova Nota';
    fabBtn.onclick = openAddModal;
    fabSec.style.display = id === 'expenses' ? 'none' : 'flex';
    if (id === 'home') renderHome();
    if (id === 'expenses') renderAll();
  }
}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const fmt  = v => 'R$ ' + Number(v).toFixed(2).replace('.', ',');
const fmtS = v => 'R$ ' + Math.round(v);
const ds   = d => d ? new Date(d + 'T12:00:00').toLocaleDateString('pt-BR') : '';
const today = () => new Date().toISOString().split('T')[0];

// ‚îÄ‚îÄ HOME ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderHome() {
  const fAdv  = deposits.filter(d=>d.tipo==='Flash').reduce((s,d)=>s+d.valor,0);
  const dAdv  = deposits.filter(d=>d.tipo==='Dep√≥sito').reduce((s,d)=>s+d.valor,0);
  const fSpent= expenses.filter(e=>e.pag==='Flash').reduce((s,e)=>s+e.valor,0);
  const dSpent= expenses.filter(e=>e.pag==='Dep√≥sito').reduce((s,e)=>s+e.valor,0);
  const total = expenses.reduce((s,e)=>s+e.valor,0);
  const fRem  = fAdv - fSpent;
  const dRem  = dAdv - dSpent;

  const bF = document.getElementById('balFlash');
  bF.textContent = fmt(fRem);
  bF.className = 'bal-val ' + (fRem >= 0 ? 'pos' : 'neg');
  document.getElementById('subFlash').innerHTML = `Adiant.: ${fmt(fAdv)}<br>Gasto: ${fmt(fSpent)}`;

  const bD = document.getElementById('balDep');
  bD.textContent = fmt(dRem);
  bD.className = 'bal-val ' + (dRem >= 0 ? 'pos' : 'neg');
  document.getElementById('subDep').innerHTML = `Adiant.: ${fmt(dAdv)}<br>Gasto: ${fmt(dSpent)}`;

  document.getElementById('totSpent').textContent = fmt(total);
  document.getElementById('totBadge').textContent = expenses.length + ' nota' + (expenses.length !== 1 ? 's' : '');

  const cs = document.getElementById('catScroll');
  cs.innerHTML = '';
  categories.forEach(cat => {
    const s = expenses.filter(e=>e.cat===cat.name).reduce((s,e)=>s+e.valor,0);
    if (!s) return;
    cs.innerHTML += `<div class="cpill"><div class="cdot" style="background:${cat.color}"></div>${cat.name} ${fmtS(s)}</div>`;
  });

  const list = document.getElementById('homeList');
  const rec = [...expenses].reverse().slice(0,5);
  list.innerHTML = rec.length === 0
    ? '<div class="empty"><div class="empty-i">üßæ</div><p style="font-size:13px">Nenhuma despesa ainda.<br>Toque em <strong>Nova Nota</strong>.</p></div>'
    : rec.map((e,i) => cardHtml(e, expenses.length-1-i)).join('');
}

function cardHtml(e, idx) {
  const cat = categories.find(c=>c.name===e.cat) || { color:'#aaa' };
  const pIcon = e.pag==='Flash' ? 'üí≥' : 'üè¶';
  const thumb = e.img ? `<img class="ethumb" src="data:image/jpeg;base64,${e.img}" alt="nota" onclick="viewImg('${e.img}',event)">` : '';
  return `<div class="ecard">
    <div class="estripe" style="background:${cat.color}"></div>
    <div class="ebody">
      <div class="etop"><div class="ename">${e.nome}</div><div class="eval">${fmt(e.valor)}</div></div>
      <div class="emeta">
        <span class="mtag mcat" style="background:${cat.color}22;color:${cat.color}">${e.cat}</span>
        ${e.data ? `<span class="mtag">${ds(e.data)}</span>` : ''}
        <span class="mtag">${pIcon} ${e.pag||'-'}</span>
        ${e.obs ? `<span class="mtag" title="${e.obs}">üìù</span>` : ''}
      </div>
    </div>
    ${thumb}
    <button class="edel" onclick="delExp(${idx},event)">‚úï</button>
  </div>`;
}

function renderAll() {
  const list = document.getElementById('allList');
  list.innerHTML = expenses.length === 0
    ? '<div class="empty"><div class="empty-i">üßæ</div><p style="font-size:13px">Nenhuma despesa.</p></div>'
    : [...expenses].reverse().map((e,ri) => cardHtml(e, expenses.length-1-ri)).join('');
}

function delExp(i, ev) {
  ev.stopPropagation();
  if (!confirm('Excluir esta despesa?')) return;
  expenses.splice(i,1); save(); renderHome(); renderAll();
  toast('Despesa removida','r');
}

function viewImg(b64, ev) {
  ev.stopPropagation();
  document.getElementById('viewerImg').src = 'data:image/jpeg;base64,' + b64;
  document.getElementById('imgViewer').classList.add('on');
}
function closeViewer() { document.getElementById('imgViewer').classList.remove('on'); }

// ‚îÄ‚îÄ DEPOSITS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderDeposits() {
  const fT = deposits.filter(d=>d.tipo==='Flash').reduce((s,d)=>s+d.valor,0);
  const dT = deposits.filter(d=>d.tipo==='Dep√≥sito').reduce((s,d)=>s+d.valor,0);
  document.getElementById('dSumFlash').textContent = fmt(fT);
  document.getElementById('dSumDep').textContent   = fmt(dT);

  const list = document.getElementById('depList');
  if (!deposits.length) {
    list.innerHTML = '<div class="empty"><div class="empty-i">üí∞</div><p style="font-size:13px">Nenhum adiantamento.<br>Toque em <strong>+ Adiantamento</strong>.</p></div>';
    return;
  }
  list.innerHTML = [...deposits].reverse().map((d,ri) => {
    const i = deposits.length-1-ri;
    const isF = d.tipo==='Flash';
    const col = isF ? 'var(--flash)' : 'var(--dep)';
    return `<div class="ditem" style="border-left:4px solid ${col}">
      <div class="ditem-l">
        <div class="ditem-tipo" style="color:${col}">${isF?'üí≥ Cart√£o Flash':'üè¶ Dep√≥sito Conta'}</div>
        <div class="ditem-data">${ds(d.data)}${d.obs?' ¬∑ '+d.obs:''}</div>
      </div>
      <div class="ditem-val" style="color:${col}">${fmt(d.valor)}</div>
      <button class="ditem-del" onclick="delDep(${i},event)">‚úï</button>
    </div>`;
  }).join('');
}

function openDepModal() {
  document.getElementById('depOverlay').classList.add('on');
  document.getElementById('dValor').value = '';
  document.getElementById('dData').value  = today();
  document.getElementById('dObs').value   = '';
  selDepT = '';
  document.querySelectorAll('#depOverlay .pay-opt').forEach(o => { o.className = 'pay-opt'; });
}
function closeDep() { document.getElementById('depOverlay').classList.remove('on'); }

function selDepTipo(el) {
  document.querySelectorAll('#depOverlay .pay-opt').forEach(o => { o.className = 'pay-opt'; });
  el.classList.add(el.dataset.pay === 'Flash' ? 'on-flash' : 'on-dep');
  selDepT = el.dataset.pay;
}

function saveDep() {
  const valor = parseFloat(document.getElementById('dValor').value);
  const data  = document.getElementById('dData').value;
  const obs   = document.getElementById('dObs').value.trim();
  if (!selDepT)       { toast('Selecione o tipo','r'); return; }
  if (!valor||valor<=0){ toast('Informe o valor','r'); return; }
  deposits.push({ tipo:selDepT, valor, data, obs, id:Date.now() });
  save(); closeDep(); renderDeposits(); renderHome();
  toast('‚úÖ Adiantamento salvo!','g');
}

function delDep(i, ev) {
  ev.stopPropagation();
  if (!confirm('Excluir este adiantamento?')) return;
  deposits.splice(i,1); save(); renderDeposits(); renderHome();
  toast('Adiantamento removido','r');
}

// ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderSettings() {
  document.getElementById('notifToggle').checked = settings.notif !== false;
  // show current key status
  const k = getGeminiKey();
  const st = document.getElementById('geminiStatus');
  if (k) {
    st.textContent = '‚úÖ Chave configurada (' + k.slice(0,8) + '...)';
    st.style.color = 'var(--green)';
  } else {
    st.textContent = '‚ö†Ô∏è Nenhuma chave salva';
    st.style.color = 'var(--amber)';
  }
  renderCatMgr();
}

function saveGeminiKey() {
  const k = document.getElementById('geminiInput').value.trim();
  if (k.length < 10) { toast('Chave muito curta','r'); return; }
  localStorage.setItem('nf_gemini', k);
  document.getElementById('geminiInput').value = '';
  renderSettings();
  toast('‚úÖ Chave Gemini salva!','g');
}

function saveSettings() {
  settings.notif = document.getElementById('notifToggle').checked;
  save();
}

function renderCatMgr() {
  document.getElementById('catMgrList').innerHTML = categories.map((cat,i) => `
    <div class="cat-mgr-item">
      <input type="color" class="col-pick" value="${cat.color}" onchange="updCatColor(${i},this.value)">
      <div class="cat-mgr-name">${cat.name}</div>
      <button class="cat-mgr-del" onclick="delCat(${i})">‚úï</button>
    </div>`).join('');
}

function updCatColor(i,c) { categories[i].color=c; save(); }

function addCat() {
  const inp = document.getElementById('newCatInp');
  const name = inp.value.trim();
  if (!name) return;
  if (categories.find(c=>c.name.toLowerCase()===name.toLowerCase())) { toast('J√° existe!','r'); return; }
  const cols = ['#e05c5c','#5ce0a0','#5c9ee0','#e0b85c','#a05ce0','#5ce0d4'];
  categories.push({ name, color: cols[categories.length % cols.length] });
  inp.value = ''; save(); renderCatMgr();
  toast('Categoria adicionada','g');
}

function delCat(i) {
  if (!confirm(`Remover "${categories[i].name}"?`)) return;
  categories.splice(i,1); save(); renderCatMgr();
  toast('Categoria removida');
}

function clearExp() {
  if (!confirm('Apagar TODAS as notas?')) return;
  expenses=[]; save(); renderHome(); renderAll(); toast('Notas apagadas');
}
function clearDep() {
  if (!confirm('Apagar TODOS os adiantamentos?')) return;
  deposits=[]; save(); renderDeposits(); renderHome(); toast('Adiantamentos apagados');
}

// ‚îÄ‚îÄ ADD MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openAddModal() {
  document.getElementById('addOverlay').classList.add('on');
  resetForm();
  renderCatGrid();
}
function closeAdd() { document.getElementById('addOverlay').classList.remove('on'); }

function resetForm() {
  document.getElementById('fNome').value  = '';
  document.getElementById('fValor').value = '';
  document.getElementById('fData').value  = today();
  document.getElementById('fObs').value   = '';
  document.getElementById('prevImg').style.display = 'none';
  document.getElementById('camPH').style.display   = 'flex';
  document.getElementById('aiBar').textContent      = '‚ú® Fotografe a nota para preencher automaticamente';
  document.getElementById('aiBar').className        = 'ai-bar';
  document.querySelectorAll('#addOverlay .pay-opt').forEach(o => { o.className = 'pay-opt'; });
  selCat = ''; selPay_ = ''; curB64 = '';
}

function renderCatGrid() {
  document.getElementById('catGrid').innerHTML =
    categories.map(cat =>
      `<div class="cat-opt${selCat===cat.name?' on':''}" data-cat="${cat.name}" onclick="pickCat(this)">
        <div class="cdot" style="background:${cat.color}"></div>${cat.name}
      </div>`).join('') +
    `<div class="cat-add" onclick="promptCat()">‚ûï Nova categoria</div>`;
}

function pickCat(el) {
  document.querySelectorAll('#catGrid .cat-opt').forEach(o => o.classList.remove('on'));
  el.classList.add('on'); selCat = el.dataset.cat;
}

function selPay(el) {
  document.querySelectorAll('#addOverlay .pay-opt').forEach(o => { o.className = 'pay-opt'; });
  el.classList.add(el.dataset.pay === 'Flash' ? 'on-flash' : 'on-dep');
  selPay_ = el.dataset.pay;
}

function promptCat() {
  const name = prompt('Nome da nova categoria:');
  if (!name?.trim()) return;
  const t = name.trim();
  if (!categories.find(c=>c.name.toLowerCase()===t.toLowerCase())) {
    const cols = ['#e05c5c','#5ce0a0','#5c9ee0','#e0b85c','#a05ce0'];
    categories.push({ name:t, color:cols[categories.length%cols.length] });
    save();
  }
  selCat = t; renderCatGrid();
}

// ‚îÄ‚îÄ CAMERA & AI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function triggerCam() {
  const fi = document.getElementById('fileInput');
  fi.setAttribute('capture','environment'); fi.click();
}
function triggerGallery() {
  const fi = document.getElementById('fileInput');
  fi.removeAttribute('capture'); fi.click();
}

async function handleFile(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = async function(ev) {
    const img = new Image();
    img.onload = async function() {
      // Compress image
      const canvas = document.createElement('canvas');
      const MAX = 1200;
      let w = img.width, h = img.height;
      if (w > MAX || h > MAX) {
        if (w > h) { h = Math.round(h*MAX/w); w = MAX; }
        else       { w = Math.round(w*MAX/h); h = MAX; }
      }
      canvas.width = w; canvas.height = h;
      canvas.getContext('2d').drawImage(img, 0, 0, w, h);
      const comp = canvas.toDataURL('image/jpeg', 0.85);
      curB64 = comp.split(',')[1];
      document.getElementById('prevImg').src = comp;
      document.getElementById('prevImg').style.display = 'block';
      document.getElementById('camPH').style.display   = 'none';
      await callGemini();
    };
    img.src = ev.target.result;
  };
  reader.readAsDataURL(file);
  e.target.value = '';
}

async function callGemini() {
  if (aiRunning) return;

  const apiKey = getGeminiKey();
  const bar = document.getElementById('aiBar');

  // ‚îÄ‚îÄ No key: show message in bar only, no popup ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if (!apiKey) {
    bar.className = 'ai-bar er';
    bar.innerHTML = 'üîë Sem chave Gemini. V√° em ‚öôÔ∏è Config para cadastrar (gratuito).';
    return;
  }

  aiRunning = true;
  bar.className = 'ai-bar ld';
  bar.innerHTML = '<div class="spin"></div> Gemini lendo a nota...';

  const catNames = categories.map(c=>c.name).join(', ');
  const prompt = `Voc√™ √© especialista em notas fiscais brasileiras impressas e ESCRITAS √Ä M√ÉO. Analise com muito cuidado e extraia:
- nome: nome do estabelecimento (m√°x 40 chars)
- valor: valor TOTAL em decimal. Procure "Total", "Total a pagar"
- data: formato YYYY-MM-DD (null se n√£o encontrar)
- categoria: classifique em: ${catNames}. Crie nome curto se n√£o encaixar
- nova_categoria: true se criou categoria nova, false caso contr√°rio
Retorne APENAS JSON v√°lido sem nenhum texto extra:
{"nome":"...","valor":0.00,"data":"YYYY-MM-DD","categoria":"...","nova_categoria":false}`;

  try {
    const res = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`,
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [
            { inline_data: { mime_type: 'image/jpeg', data: curB64 } },
            { text: prompt }
          ]}],
          generationConfig: { temperature: 0.1, maxOutputTokens: 500 }
        })
      }
    );

    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.error?.message || 'Erro ' + res.status);
    }

    const data = await res.json();
    const txt  = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
    const p    = JSON.parse(txt.replace(/```json?|```/g,'').trim());

    if (p.nome)  document.getElementById('fNome').value  = p.nome;
    if (p.valor) document.getElementById('fValor').value = p.valor;
    if (p.data)  document.getElementById('fData').value  = p.data;

    // Auto-add new category if AI identified one
    if (p.nova_categoria && p.categoria && !categories.find(c=>c.name.toLowerCase()===p.categoria.toLowerCase())) {
      const cols = ['#e05c5c','#5ce0a0','#a05ce0','#e0885c'];
      categories.push({ name:p.categoria, color:cols[categories.length%cols.length] });
      save(); renderCatMgr();
    }

    selCat = p.categoria || '';
    renderCatGrid();

    bar.className = 'ai-bar ok';
    bar.innerHTML = '‚úÖ Dados extra√≠dos! Confira e corrija se necess√°rio.';
  } catch(err) {
    bar.className = 'ai-bar er';
    bar.innerHTML = '‚ö†Ô∏è ' + (err.message || 'Erro ao ler. Preencha manualmente.');
    console.error(err);
  }
  aiRunning = false;
}

function saveExp() {
  const nome  = document.getElementById('fNome').value.trim();
  const valor = parseFloat(document.getElementById('fValor').value);
  const data  = document.getElementById('fData').value;
  const obs   = document.getElementById('fObs').value.trim();
  if (!nome)          { toast('Informe o estabelecimento','r'); return; }
  if (!valor||valor<=0){ toast('Informe o valor','r'); return; }
  if (!selCat)        { toast('Selecione a categoria','r'); return; }
  if (!selPay_)       { toast('Selecione a forma de pagamento','r'); return; }
  expenses.push({ nome, valor, data, obs, cat:selCat, pag:selPay_, img:curB64||null, id:Date.now() });
  save(); closeAdd(); renderHome();
  toast('‚úÖ Despesa salva!','g');
}

// ‚îÄ‚îÄ EXPORT EXCEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function exportExcel() {
  if (!expenses.length) { toast('Nenhuma despesa','r'); return; }
  const wb = buildWorkbook();
  const date = new Date().toLocaleDateString('pt-BR').replace(/\//g,'-');
  XLSX.writeFile(wb, `prestacao-contas-${date}.xlsx`);
  toast('‚úÖ Excel exportado!','g');
}

function buildWorkbook() {
  const fAdv  = deposits.filter(d=>d.tipo==='Flash').reduce((s,d)=>s+d.valor,0);
  const dAdv  = deposits.filter(d=>d.tipo==='Dep√≥sito').reduce((s,d)=>s+d.valor,0);
  const fSpent= expenses.filter(e=>e.pag==='Flash').reduce((s,e)=>s+e.valor,0);
  const dSpent= expenses.filter(e=>e.pag==='Dep√≥sito').reduce((s,e)=>s+e.valor,0);
  const total = expenses.reduce((s,e)=>s+e.valor,0);

  const wb = XLSX.utils.book_new();

  // Sheet 1: Despesas
  const rows = [
    ['PRESTA√á√ÉO DE CONTAS DE VIAGEM'],
    ['Gerado em:', new Date().toLocaleDateString('pt-BR')],
    [],
    ['#','DATA','ESTABELECIMENTO','CATEGORIA','PAGAMENTO','VALOR (R$)','OBSERVA√á√ÉO'],
  ];
  expenses.forEach((e,i) => rows.push([i+1, ds(e.data), e.nome, e.cat, e.pag||'', e.valor, e.obs||'']));
  rows.push([],['',' ',' ',' ','TOTAL GASTO:', total]);
  rows.push([]);
  rows.push(['RESUMO FINANCEIRO']);
  rows.push(['','Adiantado','Gasto','Saldo']);
  rows.push(['Cart√£o Flash',   fAdv,   fSpent, fAdv-fSpent]);
  rows.push(['Dep√≥sito Conta', dAdv,   dSpent, dAdv-dSpent]);
  rows.push(['TOTAL',          fAdv+dAdv, total, (fAdv+dAdv)-total]);
  rows.push([]);
  rows.push(['RESUMO POR CATEGORIA']);
  rows.push(['Categoria','Total Gasto']);
  categories.forEach(cat => {
    const s = expenses.filter(e=>e.cat===cat.name).reduce((sum,e)=>sum+e.valor,0);
    if (s) rows.push([cat.name, s]);
  });

  const ws1 = XLSX.utils.aoa_to_sheet(rows);
  ws1['!cols'] = [{wch:4},{wch:13},{wch:35},{wch:16},{wch:16},{wch:12},{wch:30}];
  XLSX.utils.book_append_sheet(wb, ws1, 'Despesas');

  // Sheet 2: Adiantamentos
  const r2 = [
    ['ADIANTAMENTOS RECEBIDOS'],[],
    ['#','DATA','TIPO','VALOR (R$)','OBSERVA√á√ÉO'],
  ];
  deposits.forEach((d,i) => r2.push([i+1, ds(d.data), d.tipo, d.valor, d.obs||'']));
  r2.push([],['',' ','TOTAL FLASH:', fAdv],['',' ','TOTAL DEP√ìSITO:', dAdv],['',' ','TOTAL:', fAdv+dAdv]);
  const ws2 = XLSX.utils.aoa_to_sheet(r2);
  ws2['!cols'] = [{wch:4},{wch:13},{wch:18},{wch:12},{wch:30}];
  XLSX.utils.book_append_sheet(wb, ws2, 'Adiantamentos');

  return wb;
}

// ‚îÄ‚îÄ EXPORT ZIP (Excel + fotos) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function exportZip() {
  if (!expenses.length) { toast('Nenhuma despesa','r'); return; }
  toast('‚è≥ Gerando ZIP...', '');

  const zip = new JSZip();

  // Add Excel
  const wb   = buildWorkbook();
  const xlsxBuf = XLSX.write(wb, { bookType:'xlsx', type:'array' });
  zip.file('prestacao-contas.xlsx', xlsxBuf);

  // Add photos
  const fotos = zip.folder('fotos-notas');
  let count = 0;
  expenses.forEach((e, i) => {
    if (!e.img) return;
    const dateLabel = e.data ? e.data.replace(/-/g,'') : 'semdata';
    const nomeSafe  = e.nome.replace(/[^a-zA-Z0-9√Ä-√∫ ]/g,'').replace(/ /g,'-').slice(0,30);
    const filename  = `${String(i+1).padStart(3,'0')}_${dateLabel}_${nomeSafe}.jpg`;
    // Convert base64 to binary
    const byteStr = atob(e.img);
    const arr = new Uint8Array(byteStr.length);
    for (let j = 0; j < byteStr.length; j++) arr[j] = byteStr.charCodeAt(j);
    fotos.file(filename, arr);
    count++;
  });

  // Add README
  zip.file('LEIA-ME.txt',
    `PRESTA√á√ÉO DE CONTAS\nGerado em: ${new Date().toLocaleDateString('pt-BR')}\n\n` +
    `üìä prestacao-contas.xlsx ‚Äî Planilha completa com despesas e adiantamentos\n` +
    `üì∏ fotos-notas/ ‚Äî ${count} foto(s) das notas fiscais\n\n` +
    `Cada foto √© nomeada: NUMERO_DATA_ESTABELECIMENTO.jpg`
  );

  const blob = await zip.generateAsync({ type:'blob' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href     = url;
  const date = new Date().toLocaleDateString('pt-BR').replace(/\//g,'-');
  a.download = `prestacao-contas-${date}.zip`;
  a.click();
  URL.revokeObjectURL(url);
  toast(`‚úÖ ZIP com ${count} foto(s) exportado!`,'g');
}

// ‚îÄ‚îÄ NOTIFICATIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function requestNotifPerm() {
  if ('Notification' in window && Notification.permission !== 'granted')
    await Notification.requestPermission();
}

function sendNotif(title, body) {
  if ('Notification' in window && Notification.permission === 'granted') {
    new Notification(title, { body });
  } else {
    document.getElementById('notifTxt').textContent = body;
    document.getElementById('notifBanner').classList.add('on');
  }
}

function closeNotif() { document.getElementById('notifBanner').classList.remove('on'); }

function testNotif() {
  sendNotif('üçΩÔ∏è NotaF√°cil', 'Notifica√ß√£o de teste! Registre suas refei√ß√µes.');
  toast('Notifica√ß√£o enviada!');
}

function checkNotifs() {
  if (settings.notif === false) return;
  const now = new Date();
  const h = now.getHours(), m = now.getMinutes();
  const td = today();
  const key = 'nf_notif_' + now.toDateString();
  const fired = JSON.parse(localStorage.getItem(key) || '{}');

  if (h===12 && m<6 && !fired.lunch) {
    const has = expenses.filter(e => e.data===td && e.cat==='Alimenta√ß√£o' && e.pag==='Flash');
    if (!has.length) {
      sendNotif('üçΩÔ∏è Hora do Almo√ßo!', 'N√£o esque√ßa de fotografar e registrar a nota do almo√ßo!');
      fired.lunch = true; localStorage.setItem(key, JSON.stringify(fired));
    }
  }
  if (h===19 && m<6 && !fired.dinner) {
    const has = expenses.filter(e => e.data===td && e.cat==='Alimenta√ß√£o' && e.pag==='Flash');
    if (has.length < 2) {
      sendNotif('üåô Hora da Janta!', 'Lembre de registrar a nota da janta!');
      fired.dinner = true; localStorage.setItem(key, JSON.stringify(fired));
    }
  }
}

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toast(msg, type='') {
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = 'toast ' + type;
  setTimeout(()=>t.classList.add('on'),10);
  setTimeout(()=>t.className='toast',2800);
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
load();
renderHome();
requestNotifPerm();
setInterval(checkNotifs, 60000);
checkNotifs();
</script>
</body>
</html>

<p>Gratuito! Cole sua chave do Google Gemini. Obtenha em <strong>aistudio.google.com</strong> ‚Üí Get API Key.</p><!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>NotaF√°cil</title>

<!-- PWA META TAGS -->
<meta name="application-name" content="NotaF√°cil">
<meta name="description" content="App de presta√ß√£o de contas para viagens corporativas. Fotografe notas, registre despesas e exporte para Excel.">
<meta name="theme-color" content="#1a1a1a">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="NotaF√°cil">
<meta name="msapplication-TileColor" content="#1a1a1a">

<!-- PWA MANIFEST -->
<link rel="manifest" href="manifest.json">

<!-- APPLE TOUCH ICON (emoji fallback) -->
<link rel="apple-touch-icon" href="icon-512.png"><rect width='100' height='100' rx='20' fill='%231a1a1a'/><text y='.9em' font-size='70' x='10'>üßæ</text></svg>">
<meta name="description" content="App de presta√ß√£o de contas para viagens corporativas">
<meta name="theme-color" content="#1a1a1a">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="NotaF√°cil">
<link rel="apple-touch-icon" href="icon-512.png">
<link rel="manifest" href="manifest.json">
<script>
if ('serviceWorker' in navigator) {
  const swCode = `
    const CACHE = 'notafacil-v3';
    const ASSETS = ['./', './index.html'];
    self.addEventListener('install', e => e.waitUntil(caches.open(CACHE).then(c => c.addAll(ASSETS))));
    self.addEventListener('fetch', e => e.respondWith(caches.match(e.request).then(r => r || fetch(e.request).catch(() => caches.match('./')))));
  `;
  const blob = new Blob([swCode], {type: 'application/javascript'});
  const swUrl = URL.createObjectURL(blob);
  navigator.serviceWorker.register(swUrl).catch(() => {});
}
</script>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root{--bg:#f5f2eb;--surface:#fff;--s2:#ede9e0;--border:#d8d2c5;--accent:#1a1a1a;--green:#2d6a4f;--gl:#d8f3dc;--red:#c1121f;--rl:#ffe5e5;--amber:#e07d10;--al:#fff3cd;--blue:#1d4e89;--bl:#dbeafe;--text:#1a1a1a;--muted:#7a7065;--flash:#e07d10;--dep:#1d4e89;}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);max-width:430px;margin:0 auto;min-height:100vh;}
.nav-tabs{display:flex;background:var(--accent);position:sticky;top:0;z-index:200;}
.nav-tab{flex:1;padding:13px 2px;text-align:center;font-size:10px;font-weight:600;letter-spacing:.3px;color:rgba(255,255,255,.4);cursor:pointer;border-bottom:2px solid transparent;transition:all .2s;text-transform:uppercase;}
.nav-tab.active{color:#fff;border-bottom-color:#f5f2eb;}
.screen{display:none;padding-bottom:110px;}.screen.active{display:block;}
.ph{padding:14px 16px 11px;background:var(--accent);color:#fff;}
.ph-title{font-family:'Bebas Neue',sans-serif;font-size:26px;letter-spacing:1px;line-height:1;}
.ph-sub{font-size:10px;opacity:.4;text-transform:uppercase;letter-spacing:1px;margin-top:1px;}
.bal-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:13px 13px 0;}
.bal-card{background:var(--surface);border-radius:14px;padding:12px;border:1px solid var(--border);}
.bl{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:3px;}
.bv{font-family:'Bebas Neue',sans-serif;font-size:22px;}
.bs{font-size:10px;color:var(--muted);margin-top:3px;font-family:'DM Mono',monospace;line-height:1.5;}
.bpos{color:var(--green);}.bneg{color:var(--red);}
.tot-card{margin:10px 13px 0;background:var(--accent);color:#fff;border-radius:14px;padding:12px 15px;display:flex;justify-content:space-between;align-items:center;}
.tot-card .bl{color:rgba(255,255,255,.5);}
.tot-card .bv{font-size:26px;}
.tot-badge{font-size:11px;background:rgba(255,255,255,.1);border-radius:20px;padding:4px 10px;color:rgba(255,255,255,.7);}
.cs{display:flex;gap:8px;padding:11px 13px;overflow-x:auto;scrollbar-width:none;}
.cp{flex-shrink:0;display:flex;align-items:center;gap:5px;padding:4px 10px;border-radius:20px;font-size:11px;font-weight:500;border:1px solid var(--border);background:var(--surface);white-space:nowrap;}
.cd{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.sl{font-size:10px;text-transform:uppercase;letter-spacing:2px;color:var(--muted);padding:5px 13px 3px;}
.el{padding:0 10px;}
.ec{background:var(--surface);border:1px solid var(--border);border-radius:12px;margin-bottom:8px;display:flex;align-items:stretch;overflow:hidden;transition:transform .15s;}
.ec:active{transform:scale(.98);}
.estr{width:4px;flex-shrink:0;}
.eb{padding:10px 10px 8px;flex:1;min-width:0;}
.et{display:flex;justify-content:space-between;align-items:flex-start;gap:6px;}
.en{font-weight:600;font-size:13px;line-height:1.2;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.ev{font-family:'DM Mono',monospace;font-size:13px;flex-shrink:0;}
.em{display:flex;gap:5px;margin-top:4px;flex-wrap:wrap;align-items:center;}
.mt{font-size:10px;padding:2px 7px;border-radius:8px;border:1px solid var(--border);color:var(--muted);}
.mc{border:none!important;font-weight:500;}
.edel{background:none;border:1px solid var(--border);color:var(--muted);border-radius:6px;padding:3px 7px;cursor:pointer;font-size:11px;align-self:center;margin-right:6px;flex-shrink:0;}
.edel:active{border-color:var(--red);color:var(--red);}
.thumb{width:36px;height:36px;border-radius:6px;object-fit:cover;flex-shrink:0;align-self:center;margin-right:6px;border:1px solid var(--border);}
.es{text-align:center;padding:45px 20px;color:var(--muted);}
.ei{font-size:36px;margin-bottom:10px;opacity:.4;}
/* DEPOSIT */
.dscr{padding:13px;}
.dsg{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:13px;}
.dsc{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:11px 12px;}
.dsl{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:3px;}
.dsv{font-family:'Bebas Neue',sans-serif;font-size:20px;}
.dlt{font-size:10px;text-transform:uppercase;letter-spacing:2px;color:var(--muted);margin-bottom:8px;}
.di{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:10px 12px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;}
.dil{flex:1;}
.dit{font-size:11px;font-weight:600;margin-bottom:2px;}
.did{font-size:10px;color:var(--muted);font-family:'DM Mono',monospace;}
.div2{font-family:'Bebas Neue',sans-serif;font-size:18px;margin-right:4px;}
.ddel{background:none;border:none;color:var(--muted);cursor:pointer;font-size:14px;padding:4px 8px;}
/* FAB */
.fab{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);display:flex;gap:8px;z-index:300;}
.fbp{background:var(--accent);color:#fff;border:none;border-radius:50px;padding:13px 20px;font-family:'DM Sans',sans-serif;font-weight:600;font-size:13px;cursor:pointer;display:flex;align-items:center;gap:6px;box-shadow:0 6px 24px rgba(0,0,0,.25);transition:all .15s;white-space:nowrap;}
.fbp:active{transform:scale(.95);box-shadow:none;}
.fbs{background:var(--surface);color:var(--text);border:1px solid var(--border);border-radius:50px;padding:13px 15px;font-family:'DM Sans',sans-serif;font-weight:600;font-size:13px;cursor:pointer;display:flex;align-items:center;gap:6px;box-shadow:0 4px 16px rgba(0,0,0,.1);transition:all .15s;white-space:nowrap;}
.fbs:active{transform:scale(.95);}
/* OVERLAY */
.ov{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:400;display:flex;align-items:flex-end;opacity:0;pointer-events:none;transition:opacity .2s;}
.ov.open{opacity:1;pointer-events:all;}
.dr{background:var(--bg);border-radius:20px 20px 0 0;width:100%;padding:0 0 36px;transform:translateY(100%);transition:transform .3s cubic-bezier(.32,1.2,.6,1);max-height:93vh;overflow-y:auto;border-top:1px solid var(--border);}
.ov.open .dr{transform:translateY(0);}
.drh{width:36px;height:4px;background:var(--border);border-radius:2px;margin:12px auto 0;}
.drhd{padding:12px 17px 10px;border-bottom:1px solid var(--border);}
.drt{font-family:'Bebas Neue',sans-serif;font-size:21px;letter-spacing:.5px;}
.drb{padding:13px 17px;}
/* FORM */
.fg{margin-bottom:12px;}
.fl{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--muted);display:block;margin-bottom:5px;font-weight:600;}
.fi{width:100%;background:var(--surface);border:1.5px solid var(--border);border-radius:10px;padding:10px 12px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;outline:none;transition:border-color .2s;}
.fi:focus{border-color:var(--accent);}
.fr{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.fta{width:100%;background:var(--surface);border:1.5px solid var(--border);border-radius:10px;padding:10px 12px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;outline:none;resize:none;min-height:60px;}
.fta:focus{border-color:var(--accent);}
/* CAMERA */
.ca{border:2px dashed var(--border);border-radius:12px;aspect-ratio:4/3;background:var(--s2);display:flex;align-items:center;justify-content:center;overflow:hidden;margin-bottom:10px;cursor:pointer;}
.ca img{width:100%;height:100%;object-fit:cover;display:none;}
.caph{text-align:center;color:var(--muted);}
.caph .ci{font-size:30px;margin-bottom:5px;}
.caph p{font-size:12px;}
#fi2{display:none;}
.cbs{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px;}
.cb{background:var(--s2);border:1px solid var(--border);border-radius:10px;padding:9px;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:500;cursor:pointer;color:var(--text);}
.cb:active{transform:scale(.97);}
/* AI */
.ab{background:var(--surface);border:1.5px solid var(--border);border-radius:10px;padding:9px 12px;font-size:12px;color:var(--muted);display:flex;align-items:center;gap:8px;margin-bottom:12px;min-height:40px;}
.ab.ld{border-color:var(--amber);color:var(--amber);background:var(--al);}
.ab.dn{border-color:var(--green);color:var(--green);background:var(--gl);}
.ab.er{border-color:var(--red);color:var(--red);background:var(--rl);}
.sp{width:12px;height:12px;border:2px solid currentColor;border-top-color:transparent;border-radius:50%;animation:spin .7s linear infinite;flex-shrink:0;}
@keyframes spin{to{transform:rotate(360deg);}}
/* CAT */
.cg{display:grid;grid-template-columns:1fr 1fr;gap:7px;}
.co{border:1.5px solid var(--border);border-radius:10px;padding:8px 10px;cursor:pointer;font-size:12px;font-weight:500;display:flex;align-items:center;gap:6px;transition:all .15s;background:var(--surface);}
.co.sel{border-color:var(--accent);background:var(--accent);color:#fff;}
.co.sel .cd{background:#fff!important;}
.coa{border:1.5px dashed var(--border);border-radius:10px;padding:8px 10px;cursor:pointer;font-size:12px;display:flex;align-items:center;gap:6px;color:var(--muted);background:var(--surface);}
/* PAY */
.pg{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.po{border:1.5px solid var(--border);border-radius:10px;padding:11px;cursor:pointer;font-size:13px;font-weight:600;text-align:center;transition:all .15s;background:var(--surface);}
.po.sf{border-color:var(--flash);background:var(--al);color:var(--flash);}
.po.sd{border-color:var(--dep);background:var(--bl);color:var(--dep);}
/* SETTINGS */
.ss{padding:13px;}
.sc{background:var(--surface);border:1px solid var(--border);border-radius:14px;margin-bottom:12px;overflow:hidden;}
.sch{padding:12px 15px;border-bottom:1px solid var(--border);font-weight:600;font-size:13px;display:flex;justify-content:space-between;align-items:center;}
.scb{padding:12px 15px;}
.sr{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border);}
.sr:last-child{border-bottom:none;}
.srl{font-size:13px;}
.srv{font-family:'DM Mono',monospace;font-size:13px;color:var(--muted);}
.cmi{display:flex;align-items:center;gap:10px;padding:7px 0;border-bottom:1px solid var(--border);}
.cmi:last-child{border-bottom:none;}
.ccp{width:24px;height:24px;border-radius:50%;border:none;cursor:pointer;padding:0;flex-shrink:0;}
.cmn{flex:1;font-size:13px;font-weight:500;}
.cmd{background:none;border:none;cursor:pointer;color:var(--muted);font-size:16px;padding:4px;}
.acr{display:flex;gap:8px;margin-top:10px;}
.aci{flex:1;background:var(--s2);border:1px solid var(--border);border-radius:8px;padding:8px 10px;font-family:'DM Sans',sans-serif;font-size:13px;color:var(--text);outline:none;}
.aci:focus{border-color:var(--accent);}
.bsm{background:var(--accent);color:#fff;border:none;border-radius:8px;padding:8px 12px;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;cursor:pointer;}
.bsave{background:var(--accent);color:#fff;border:none;border-radius:12px;padding:13px;font-family:'DM Sans',sans-serif;font-weight:600;font-size:15px;cursor:pointer;width:100%;margin-top:8px;}
.bsave:active{transform:scale(.98);}
/* TOGGLE */
.tg{position:relative;width:40px;height:22px;flex-shrink:0;}
.tg input{opacity:0;width:0;height:0;}
.tgs{position:absolute;inset:0;background:var(--border);border-radius:11px;cursor:pointer;transition:.2s;}
.tgs:before{content:'';position:absolute;width:16px;height:16px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:.2s;}
.tg input:checked+.tgs{background:var(--green);}
.tg input:checked+.tgs:before{transform:translateX(18px);}
/* NOTIF */
.nb{margin:11px 13px 0;background:var(--al);border:1px solid var(--amber);border-radius:12px;padding:10px 12px;font-size:12px;color:var(--amber);align-items:center;gap:8px;display:none;}
.nb.show{display:flex;}
.nd{margin-left:auto;background:none;border:none;cursor:pointer;color:var(--amber);font-size:16px;}
/* TOAST */
.toast{position:fixed;bottom:82px;left:50%;transform:translateX(-50%) translateY(10px);background:var(--accent);color:#fff;border-radius:50px;padding:10px 18px;font-size:13px;font-weight:500;opacity:0;transition:all .25s;pointer-events:none;z-index:999;white-space:nowrap;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
.toast.green{background:var(--green);}.toast.red{background:var(--red);}
::-webkit-scrollbar{width:0;height:0;}
</style>
</head>
<body>

<div class="nav-tabs">
  <div class="nav-tab active" onclick="SS('home')">üè† In√≠cio</div>
  <div class="nav-tab" onclick="SS('expenses')">üßæ Notas</div>
  <div class="nav-tab" onclick="SS('deposits')">üí∞ Dep√≥sitos</div>
  <div class="nav-tab" onclick="SS('settings')">‚öôÔ∏è Config</div>
</div>

<!-- HOME -->
<div class="screen active" id="screen-home">
  <div class="ph"><div class="ph-title">NotaF√°cil</div><div class="ph-sub">Presta√ß√£o de Contas</div></div>
  <div id="nb" class="nb">üîî <span id="nt"></span><button class="nd" onclick="DN()">‚úï</button></div>
  <div class="bal-grid">
    <div class="bal-card"><div class="bl">üí≥ Cart√£o Flash</div><div class="bv" id="fBal">R$ 0</div><div class="bs" id="fSub">‚Äî</div></div>
    <div class="bal-card"><div class="bl">üè¶ Dep√≥sito Conta</div><div class="bv" id="dBal">R$ 0</div><div class="bs" id="dSub">‚Äî</div></div>
  </div>
  <div class="tot-card"><div><div class="bl">Total gasto</div><div class="bv" id="tSpent">R$ 0,00</div></div><div class="tot-badge" id="tBadge">0 notas</div></div>
  <div class="cs" id="cScroll"></div>
  <div class="sl">√öltimas despesas</div>
  <div class="el" id="hEl"></div>
</div>

<!-- NOTAS -->
<div class="screen" id="screen-expenses">
  <div class="ph"><div class="ph-title">Todas as Notas</div></div>
  <div class="el" style="padding-top:10px" id="aEl"></div>
</div>

<!-- DEP√ìSITOS -->
<div class="screen" id="screen-deposits">
  <div class="ph"><div class="ph-title">Dep√≥sitos Recebidos</div><div class="ph-sub">Valores recebidos da empresa</div></div>
  <div class="dscr">
    <div class="dsg">
      <div class="dsc"><div class="dsl">üí≥ Total Flash</div><div class="dsv" id="tFA" style="color:var(--flash)">R$ 0</div></div>
      <div class="dsc"><div class="dsl">üè¶ Total Dep√≥sito</div><div class="dsv" id="tDA" style="color:var(--dep)">R$ 0</div></div>
    </div>
    <div class="dlt">Hist√≥rico</div>
    <div id="dList"></div>
  </div>
</div>

<!-- CONFIG -->
<div class="screen" id="screen-settings">
  <div class="ph"><div class="ph-title">Configura√ß√µes</div></div>
  <div class="ss">
    <div class="sc">
      <div class="sch">üîë Gemini API Key <span style="font-size:10px;color:var(--green);font-weight:400;background:var(--green-light);padding:2px 8px;border-radius:10px;margin-left:6px;">GRATUITA</span></div>
      <div class="scb">
        <div style="font-size:12px;color:var(--muted);margin-bottom:10px;line-height:1.7;">
          1. Acesse <strong>aistudio.google.com</strong><br>
          2. Clique em <strong>Get API Key ‚Üí Create API key</strong><br>
          3. Cole abaixo e salve
        </div>
        <div style="display:flex;gap:8px;">
          <input type="password" class="fi" id="geminiKeyInput" placeholder="AIzaSy..." style="font-family:'DM Mono',monospace;font-size:12px;">
          <button class="bsm" onclick="saveGeminiKey()">Salvar</button>
        </div>
        <div id="geminiKeyStatus" style="font-size:11px;margin-top:6px;"></div>
      </div>
    </div>

    <div class="sc">
      <div class="sch">üîî Lembretes de Refei√ß√£o</div>
      <div class="scb">
        <div class="sr"><div class="srl">Lembretes ativos</div><label class="tg"><input type="checkbox" id="nEn" checked onchange="svS();rNP()"><span class="tgs"></span></label></div>
        <div class="sr"><div class="srl">üçΩ Almo√ßo</div><div class="srv">12:00</div></div>
        <div class="sr"><div class="srl">üåô Janta</div><div class="srv">19:00</div></div>
        <div style="margin-top:10px"><button class="bsm" onclick="tN()">Testar notifica√ß√£o</button></div>
      </div>
    </div>
    <div class="sc">
      <div class="sch">üè∑ Categorias</div>
      <div class="scb" id="cML"></div>
      <div style="padding:0 15px 13px">
        <div class="acr"><input class="aci" id="nCN" placeholder="Nova categoria..." onkeydown="if(event.key==='Enter')addCat()"><button class="bsm" onclick="addCat()">+ Adicionar</button></div>
      </div>
    </div>
    <div class="sc">
      <div class="sch">üìä Exportar</div>
      <div class="scb"><button class="bsave" onclick="expXL()" style="margin-top:0">‚¨á Exportar Excel Completo</button><div style="font-size:11px;color:var(--muted);margin-top:7px;text-align:center">Data ¬∑ Categoria ¬∑ Pagamento ¬∑ Valores ¬∑ Saldo</div></div>
    </div>
    <div class="sc">
      <div class="sch" style="color:var(--red)">‚ö†Ô∏è Zona de Risco</div>
      <div class="scb" style="display:flex;flex-direction:column;gap:8px;">
        <button onclick="clrE()" style="background:var(--rl);color:var(--red);border:1px solid var(--red);border-radius:10px;padding:10px;font-family:'DM Sans',sans-serif;font-size:13px;cursor:pointer;font-weight:600;">üóë Apagar todas as notas</button>
        <button onclick="clrD()" style="background:var(--rl);color:var(--red);border:1px solid var(--red);border-radius:10px;padding:10px;font-family:'DM Sans',sans-serif;font-size:13px;cursor:pointer;font-weight:600;">üóë Apagar todos os dep√≥sitos</button>
      </div>
    </div>
  </div>
</div>

<!-- FAB -->
<div class="fab" id="mFab">
  <button class="fbp" id="fBtn" onclick="openAdd()">üì∑ Nova Nota</button>
  <button class="fbs" id="fBtn2" onclick="expXL()">‚¨á Excel</button>
</div>

<!-- MODAL: NOVA NOTA -->
<div class="ov" id="addOv" onclick="if(event.target===this)closeAdd()">
  <div class="dr">
    <div class="drh"></div>
    <div class="drhd"><div class="drt">üì∑ Nova Despesa</div></div>
    <div class="drb">
      <div class="ca" id="cArea" onclick="tCam()">
        <div class="caph" id="cPH"><div class="ci">üì∏</div><p>Toque para fotografar a nota</p></div>
        <img id="pImg" alt="preview">
      </div>
      <input type="file" id="fi2" accept="image/*" onchange="hFile(event)">
      <div class="cbs">
        <button class="cb" onclick="tCam()">üì∑ C√¢mera</button>
        <button class="cb" onclick="tGal()">üñº Galeria</button>
      </div>
      <div class="ab" id="aBar">‚ú® Tire uma foto ‚Äî a IA l√™ e preenche os dados automaticamente</div>
      <div class="fg"><label class="fl">Estabelecimento / Descri√ß√£o</label><input type="text" class="fi" id="fN" placeholder="Ex: Restaurante Central"></div>
      <div class="fr">
        <div class="fg"><label class="fl">Valor (R$)</label><input type="number" class="fi" id="fV" placeholder="0,00" step="0.01" min="0"></div>
        <div class="fg"><label class="fl">Data</label><input type="date" class="fi" id="fD"></div>
      </div>
      <div class="fg"><label class="fl">Categoria</label><div class="cg" id="cGrid"></div></div>
      <div class="fg">
        <label class="fl">Forma de Pagamento</label>
        <div class="pg">
          <div class="po" data-pay="Flash" onclick="selPay(this)">üí≥ Cart√£o Flash</div>
          <div class="po" data-pay="Dep√≥sito" onclick="selPay(this)">üè¶ Dep√≥sito</div>
        </div>
      </div>
      <div class="fg"><label class="fl">Observa√ß√£o (opcional)</label><textarea class="fta" id="fO" placeholder="Ex: reuni√£o com cliente..."></textarea></div>
      <button class="bsave" onclick="saveExp()">‚úì Salvar Despesa</button>
    </div>
  </div>
</div>

<!-- MODAL: NOVO DEP√ìSITO -->
<div class="ov" id="depOv" onclick="if(event.target===this)closeDep()">
  <div class="dr">
    <div class="drh"></div>
    <div class="drhd"><div class="drt">üí∞ Registrar Dep√≥sito</div></div>
    <div class="drb">
      <div style="background:var(--s2);border-radius:12px;padding:12px;margin-bottom:13px;font-size:12px;color:var(--muted);line-height:1.6;">
        Registre cada valor que a empresa depositou. Pode adicionar v√°rios ao longo da viagem ‚Äî o app soma tudo e calcula o saldo automaticamente.
      </div>
      <div class="fg">
        <label class="fl">Tipo de dep√≥sito</label>
        <div class="pg">
          <div class="po" data-dt="Flash" onclick="selDT(this)">üí≥ Cart√£o Flash</div>
          <div class="po" data-dt="Dep√≥sito" onclick="selDT(this)">üè¶ Dep√≥sito Conta</div>
        </div>
      </div>
      <div class="fr">
        <div class="fg"><label class="fl">Valor (R$)</label><input type="number" class="fi" id="dV" placeholder="Ex: 300,00" step="0.01" min="0"></div>
        <div class="fg"><label class="fl">Data do dep√≥sito</label><input type="date" class="fi" id="dD"></div>
      </div>
      <div class="fg"><label class="fl">Observa√ß√£o (opcional)</label><input type="text" class="fi" id="dO" placeholder="Ex: adiantamento ter√ßa-feira"></div>
      <button class="bsave" onclick="saveDep()">‚úì Confirmar Dep√≥sito</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
var expenses=[],deposits=[],categories=[],settings={};
var sC='',sP='',sDT='',cb64='',aiR=false;
var DC=[{name:'Alimenta√ß√£o',color:'#e07d10'},{name:'Transporte',color:'#1d4e89'},{name:'Lavanderia',color:'#7b2d8b'},{name:'Outros',color:'#2d6a4f'}];

function ld(){
  try{expenses=JSON.parse(localStorage.getItem('nf_e')||'[]');}catch(e){expenses=[];}
  try{deposits=JSON.parse(localStorage.getItem('nf_d')||'[]');}catch(e){deposits=[];}
  try{categories=JSON.parse(localStorage.getItem('nf_c')||'null')||DC.map(function(c){return Object.assign({},c);});}catch(e){categories=DC.map(function(c){return Object.assign({},c);});}
  try{settings=Object.assign({notifEnabled:true},JSON.parse(localStorage.getItem('nf_s')||'{}'));}catch(e){settings={notifEnabled:true};}
}
function sv(){
  localStorage.setItem('nf_e',JSON.stringify(expenses));
  localStorage.setItem('nf_d',JSON.stringify(deposits));
  localStorage.setItem('nf_c',JSON.stringify(categories));
  localStorage.setItem('nf_s',JSON.stringify(settings));
}

function SS(id){
  document.querySelectorAll('.screen').forEach(function(s){s.classList.remove('active');});
  document.querySelectorAll('.nav-tab').forEach(function(t){t.classList.remove('active');});
  document.getElementById('screen-'+id).classList.add('active');
  ['home','expenses','deposits','settings'].forEach(function(s,i){if(s===id)document.querySelectorAll('.nav-tab')[i].classList.add('active');});
  var fab=document.getElementById('mFab'),fbtn=document.getElementById('fBtn'),fbtn2=document.getElementById('fBtn2');
  if(id==='settings'){fab.style.display='none';return;}
  fab.style.display='flex';
  if(id==='deposits'){fbtn.innerHTML='üí∞ Novo Dep√≥sito';fbtn.onclick=openDep;fbtn2.style.display='none';}
  else{fbtn.innerHTML='üì∑ Nova Nota';fbtn.onclick=openAdd;fbtn2.style.display='flex';}
  if(id==='home')rH();
  if(id==='expenses')rAE();
  if(id==='deposits')rD();
  if(id==='settings')rSet();
}

function fmt(v){return 'R$ '+(v||0).toFixed(2).replace('.',',');}
function fmtS(v){return 'R$ '+Math.round(v||0);}
function fD(d){return d?new Date(d+'T12:00:00').toLocaleDateString('pt-BR'):'';}

function rH(){
  var fA=deposits.filter(function(d){return d.tipo==='Flash';}).reduce(function(s,d){return s+d.valor;},0);
  var dA=deposits.filter(function(d){return d.tipo==='Dep√≥sito';}).reduce(function(s,d){return s+d.valor;},0);
  var fS=expenses.filter(function(e){return e.pagamento==='Flash';}).reduce(function(s,e){return s+e.valor;},0);
  var dS=expenses.filter(function(e){return e.pagamento==='Dep√≥sito';}).reduce(function(s,e){return s+e.valor;},0);
  var tot=expenses.reduce(function(s,e){return s+e.valor;},0);
  var fR=fA-fS,dR=dA-dS;
  var fEl=document.getElementById('fBal');fEl.textContent=fmt(fR);fEl.className='bv '+(fR>=0?'bpos':'bneg');
  document.getElementById('fSub').innerHTML='Recebido: '+fmt(fA)+'<br>Gasto: '+fmt(fS);
  var dEl=document.getElementById('dBal');dEl.textContent=fmt(dR);dEl.className='bv '+(dR>=0?'bpos':'bneg');
  document.getElementById('dSub').innerHTML='Recebido: '+fmt(dA)+'<br>Gasto: '+fmt(dS);
  document.getElementById('tSpent').textContent=fmt(tot);
  document.getElementById('tBadge').textContent=expenses.length+' nota'+(expenses.length!==1?'s':'');
  var cs=document.getElementById('cScroll');cs.innerHTML='';
  categories.forEach(function(cat){
    var sum=expenses.filter(function(e){return e.categoria===cat.name;}).reduce(function(s,e){return s+e.valor;},0);
    if(sum>0)cs.innerHTML+='<div class="cp"><div class="cd" style="background:'+cat.color+'"></div>'+cat.name+' '+fmtS(sum)+'</div>';
  });
  var recent=expenses.slice().reverse().slice(0,5);
  var list=document.getElementById('hEl');
  list.innerHTML=recent.length===0?'<div class="es"><div class="ei">üßæ</div><p style="font-size:13px">Nenhuma despesa ainda.<br>Toque em <strong>Nova Nota</strong>.</p></div>':recent.map(function(e,i){return eCard(e,expenses.length-1-i);}).join('');
}

function eCard(e,idx){
  var cat=categories.find(function(c){return c.name===e.categoria;})||{color:'#aaa'};
  var pi=e.pagamento==='Flash'?'üí≥':'üè¶';
  var th=e.thumb?'<img class="thumb" src="'+e.thumb+'" alt="">':'';
  return '<div class="ec"><div class="estr" style="background:'+cat.color+'"></div><div class="eb"><div class="et"><div class="en">'+e.nome+'</div><div class="ev">'+fmt(e.valor)+'</div></div><div class="em"><span class="mt mc" style="background:'+cat.color+'22;color:'+cat.color+'">'+e.categoria+'</span>'+(e.data?'<span class="mt">'+fD(e.data)+'</span>':'')+'<span class="mt">'+pi+' '+e.pagamento+'</span>'+(e.obs?'<span class="mt">üìù</span>':'')+'</div></div>'+th+'<button class="edel" onclick="delE('+idx+',event)">‚úï</button></div>';
}

function rAE(){
  var list=document.getElementById('aEl');
  if(!expenses.length){list.innerHTML='<div class="es"><div class="ei">üßæ</div><p style="font-size:13px">Nenhuma despesa ainda.</p></div>';return;}
  list.innerHTML=expenses.slice().reverse().map(function(e,ri){return eCard(e,expenses.length-1-ri);}).join('');
}

function delE(i,ev){
  ev.stopPropagation();
  if(!confirm('Excluir esta despesa?'))return;
  expenses.splice(i,1);sv();rH();rAE();toast('Despesa removida','red');
}

function rD(){
  var ft=deposits.filter(function(d){return d.tipo==='Flash';}).reduce(function(s,d){return s+d.valor;},0);
  var dt=deposits.filter(function(d){return d.tipo==='Dep√≥sito';}).reduce(function(s,d){return s+d.valor;},0);
  document.getElementById('tFA').textContent=fmt(ft);
  document.getElementById('tDA').textContent=fmt(dt);
  var list=document.getElementById('dList');
  if(!deposits.length){list.innerHTML='<div class="es"><div class="ei">üí∞</div><p style="font-size:13px">Nenhum dep√≥sito registrado.<br>Toque em <strong>Novo Dep√≥sito</strong>.</p></div>';return;}
  list.innerHTML=deposits.slice().reverse().map(function(d,ri){
    var i=deposits.length-1-ri;
    var isF=d.tipo==='Flash';var cl=isF?'var(--flash)':'var(--dep)';var ic=isF?'üí≥':'üè¶';
    return '<div class="di"><div class="dil"><div class="dit" style="color:'+cl+'">'+ic+' '+d.tipo+'</div><div class="did">'+fD(d.data)+(d.obs?' ¬∑ '+d.obs:'')+'</div></div><div class="div2" style="color:'+cl+'">'+fmt(d.valor)+'</div><button class="ddel" onclick="delD('+i+',event)">‚úï</button></div>';
  }).join('');
}

function delD(i,ev){
  ev.stopPropagation();
  if(!confirm('Excluir este dep√≥sito?'))return;
  deposits.splice(i,1);sv();rD();rH();toast('Dep√≥sito removido','red');
}

function openDep(){
  document.getElementById('depOv').classList.add('open');
  document.getElementById('dV').value='';
  document.getElementById('dD').value=new Date().toISOString().split('T')[0];
  document.getElementById('dO').value='';
  sDT='';document.querySelectorAll('[data-dt]').forEach(function(o){o.className='po';});
}
function closeDep(){document.getElementById('depOv').classList.remove('open');}
function selDT(el){document.querySelectorAll('[data-dt]').forEach(function(o){o.className='po';});el.classList.add(el.dataset.dt==='Flash'?'sf':'sd');sDT=el.dataset.dt;}
function saveDep(){
  var val=parseFloat(document.getElementById('dV').value);
  var dat=document.getElementById('dD').value;
  var obs=document.getElementById('dO').value.trim();
  if(!sDT){toast('Selecione o tipo','red');return;}
  if(!val||val<=0){toast('Informe o valor','red');return;}
  if(!dat){toast('Informe a data','red');return;}
  deposits.push({tipo:sDT,valor:val,data:dat,obs:obs,id:Date.now()});
  sv();closeDep();rD();rH();toast('‚úÖ Dep√≥sito registrado!','green');
}

function rSet(){updateGeminiKeyStatus();document.getElementById('nEn').checked=settings.notifEnabled;rCM();}
function svS(){settings.notifEnabled=document.getElementById('nEn').checked;sv();}
function rCM(){
  document.getElementById('cML').innerHTML=categories.map(function(cat,i){
    return '<div class="cmi"><input type="color" class="ccp" value="'+cat.color+'" onchange="upCC('+i+',this.value)"><div class="cmn">'+cat.name+'</div><button class="cmd" onclick="delCat('+i+')">‚úï</button></div>';
  }).join('');
}
function upCC(i,c){categories[i].color=c;sv();}
function addCat(){
  var input=document.getElementById('nCN');var name=input.value.trim();
  if(!name)return;
  if(categories.find(function(c){return c.name.toLowerCase()===name.toLowerCase();})){toast('J√° existe','red');return;}
  var cols=['#e05c5c','#5ce0a0','#5c9ee0','#e0b85c','#a05ce0','#5ce0d4'];
  categories.push({name:name,color:cols[categories.length%cols.length]});
  input.value='';sv();rCM();toast('Categoria adicionada','green');
}
function delCat(i){if(!confirm('Remover "'+categories[i].name+'"?'))return;categories.splice(i,1);sv();rCM();toast('Removida');}
function clrE(){if(!confirm('Apagar TODAS as notas?'))return;expenses=[];sv();rH();rAE();toast('Notas apagadas');}
function clrD(){if(!confirm('Apagar TODOS os dep√≥sitos?'))return;deposits=[];sv();rD();rH();toast('Dep√≥sitos apagados');}

function openAdd(){document.getElementById('addOv').classList.add('open');resetAdd();rCG();}
function closeAdd(){document.getElementById('addOv').classList.remove('open');}
function resetAdd(){
  document.getElementById('fN').value='';
  document.getElementById('fV').value='';
  document.getElementById('fD').value=new Date().toISOString().split('T')[0];
  document.getElementById('fO').value='';
  document.getElementById('pImg').style.display='none';
  document.getElementById('cPH').style.display='flex';
  document.getElementById('aBar').textContent='‚ú® Tire uma foto ‚Äî a IA l√™ e preenche os dados automaticamente';
  document.getElementById('aBar').className='ab';
  sC='';sP='';cb64='';
  document.querySelectorAll('.po').forEach(function(o){o.className='po';});
}
function rCG(){
  document.getElementById('cGrid').innerHTML=
    categories.map(function(cat){return '<div class="co" data-cat="'+cat.name+'" onclick="selC(this)"><div class="cd" style="background:'+cat.color+'"></div>'+cat.name+'</div>';}).join('')+
    '<div class="coa" onclick="pNC()">‚ûï Nova categoria</div>';
}
function selC(el){document.querySelectorAll('.co').forEach(function(o){o.classList.remove('sel');});el.classList.add('sel');sC=el.dataset.cat;}
function selPay(el){document.querySelectorAll('.po').forEach(function(o){o.className='po';});el.classList.add(el.dataset.pay==='Flash'?'sf':'sd');sP=el.dataset.pay;}
function pNC(){
  var name=prompt('Nome da nova categoria:');if(!name||!name.trim())return;
  var t=name.trim();
  if(!categories.find(function(c){return c.name.toLowerCase()===t.toLowerCase();})){
    var cols=['#e05c5c','#5ce0a0','#5c9ee0','#e0b85c','#a05ce0'];
    categories.push({name:t,color:cols[categories.length%cols.length]});sv();
  }
  rCG();
  var opt=document.querySelector('.co[data-cat="'+t+'"]');if(opt)selC(opt);
}

function tCam(){var fi=document.getElementById('fi2');fi.setAttribute('capture','environment');fi.click();}
function tGal(){var fi=document.getElementById('fi2');fi.removeAttribute('capture');fi.click();}

async function hFile(e){
  var file=e.target.files[0];if(!file)return;
  var compressed=await compImg(file,1024,0.82);
  document.getElementById('pImg').src=compressed;
  document.getElementById('pImg').style.display='block';
  document.getElementById('cPH').style.display='none';
  cb64=compressed.split(',')[1];
  e.target.value='';
  await callAI();
}

function compImg(file,maxS,q){
  return new Promise(function(resolve){
    var img=new Image();var url=URL.createObjectURL(file);
    img.onload=function(){
      URL.revokeObjectURL(url);
      var w=img.width,h=img.height;
      if(w>maxS||h>maxS){if(w>h){h=Math.round(h*maxS/w);w=maxS;}else{w=Math.round(w*maxS/h);h=maxS;}}
      var c=document.createElement('canvas');c.width=w;c.height=h;
      c.getContext('2d').drawImage(img,0,0,w,h);
      resolve(c.toDataURL('image/jpeg',q));
    };
    img.src=url;
  });
}

async function callAI(){
  if(aiRunning)return;
  var apiKey=localStorage.getItem('nf_gemini_key')||'';
  if(!apiKey){
    var bar=document.getElementById('aiBar');
    bar.className='ai-bar error';
    bar.innerHTML='üîë V√° em ‚öôÔ∏è Config e cadastre sua chave gratuita do Gemini.';
    return;
  }
  aiRunning=true;
  var bar=document.getElementById('aiBar');
  bar.className='ai-bar loading';
  bar.innerHTML='<div class="spinner"></div> Gemini lendo a nota...';
  var catNm=categories.map(function(c){return c.name;}).join(', ');
  var prompt='Voc√™ √© especialista em leitura de notas fiscais brasileiras impressas e ESCRITAS √Ä M√ÉO. Analise com muito cuidado a imagem e extraia:\n- nome: nome do estabelecimento (m√°x 40 chars)\n- valor: valor TOTAL em decimal. Procure Total, Total a pagar\n- data: formato YYYY-MM-DD (null se n√£o encontrar)\n- categoria: classifique em: '+catNm+'. Crie nome curto se n√£o encaixar\n- nova_categoria: true se criou nova, false caso contr√°rio\nRetorne APENAS JSON v√°lido sem texto extra:\n{"nome":"...","valor":0.00,"data":"YYYY-MM-DD","categoria":"...","nova_categoria":false}';
  try{
    var res=await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key='+apiKey,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        contents:[{parts:[
          {inline_data:{mime_type:'image/jpeg',data:currentBase64}},
          {text:prompt}
        ]}],
        generationConfig:{temperature:0.1,maxOutputTokens:500}
      })
    });
    if(!res.ok){var e=await res.json();throw new Error(e.error&&e.error.message||'Erro '+res.status);}
    var data=await res.json();
    var txt=(data.candidates&&data.candidates[0]&&data.candidates[0].content&&data.candidates[0].content.parts&&data.candidates[0].content.parts[0]&&data.candidates[0].content.parts[0].text)||'';
    var p=JSON.parse(txt.replace(/```json?|```/g,'').trim());
    if(p.nome)document.getElementById('fNome').value=p.nome;
    if(p.valor)document.getElementById('fValor').value=p.valor;
    if(p.data)document.getElementById('fData').value=p.data;
    if(p.nova_categoria&&p.categoria&&!categories.find(function(c){return c.name.toLowerCase()===p.categoria.toLowerCase();})){
      var cols=['#e05c5c','#5ce0a0','#a05ce0','#e0885c'];
      categories.push({name:p.categoria,color:cols[categories.length%cols.length]});
      sv();rCM();
    }
    rCG();
    if(p.categoria){setTimeout(function(){var opt=document.querySelector('.cat-opt[data-cat="'+p.categoria+'"]');if(opt)selC(opt);},50);}
    bar.className='ai-bar done';
    bar.innerHTML='‚úÖ Gemini leu a nota! Confira e corrija se necess√°rio.';
  }catch(err){
    bar.className='ai-bar error';
    bar.innerHTML='‚ö†Ô∏è '+(err.message||'Erro ao ler. Preencha manualmente.');
    console.error(err);
  }
  aiRunning=false;
}
function saveExp(){
  var nome=document.getElementById('fN').value.trim();
  var val=parseFloat(document.getElementById('fV').value);
  var dat=document.getElementById('fD').value;
  var obs=document.getElementById('fO').value.trim();
  if(!nome){toast('Informe o estabelecimento','red');return;}
  if(!val||val<=0){toast('Informe o valor','red');return;}
  if(!sC){toast('Selecione a categoria','red');return;}
  if(!sP){toast('Selecione a forma de pagamento','red');return;}
  var thumb=null;
  if(cb64){try{var c=document.createElement('canvas');var img=document.getElementById('pImg');var sc=Math.min(80/img.naturalWidth,80/img.naturalHeight);c.width=img.naturalWidth*sc;c.height=img.naturalHeight*sc;c.getContext('2d').drawImage(img,0,0,c.width,c.height);thumb=c.toDataURL('image/jpeg',0.6);}catch(e){}}
  expenses.push({nome:nome,valor:val,data:dat,obs:obs,categoria:sC,pagamento:sP,thumb:thumb,id:Date.now()});
  sv();closeAdd();rH();toast('‚úÖ Despesa salva!','green');
}

function expXL(){
  if(!expenses.length){toast('Nenhuma despesa para exportar','red');return;}
  var fA=deposits.filter(function(d){return d.tipo==='Flash';}).reduce(function(s,d){return s+d.valor;},0);
  var dA=deposits.filter(function(d){return d.tipo==='Dep√≥sito';}).reduce(function(s,d){return s+d.valor;},0);
  var fS=expenses.filter(function(e){return e.pagamento==='Flash';}).reduce(function(s,e){return s+e.valor;},0);
  var dS=expenses.filter(function(e){return e.pagamento==='Dep√≥sito';}).reduce(function(s,e){return s+e.valor;},0);
  var tot=expenses.reduce(function(s,e){return s+e.valor;},0);
  var wb=XLSX.utils.book_new();
  var rows=[['PRESTA√á√ÉO DE CONTAS DE VIAGEM'],['Gerado em:',new Date().toLocaleString('pt-BR')],[],['#','DATA','ESTABELECIMENTO','CATEGORIA','PAGAMENTO','VALOR (R$)','OBSERVA√á√ÉO']];
  expenses.forEach(function(e,i){rows.push([i+1,fD(e.data),e.nome,e.categoria,e.pagamento||'',e.valor,e.obs||'']);});
  rows.push([],[],['','','','','TOTAL GASTO',tot]);
  rows.push([],['RESUMO FINANCEIRO'],['','Recebido','Gasto','Saldo']);
  rows.push(['Cart√£o Flash',fA,fS,fA-fS]);
  rows.push(['Dep√≥sito Conta',dA,dS,dA-dS]);
  rows.push(['TOTAL',fA+dA,tot,(fA+dA)-tot]);
  rows.push([],['RESUMO POR CATEGORIA'],['Categoria','Total Gasto']);
  categories.forEach(function(cat){var s=expenses.filter(function(e){return e.categoria===cat.name;}).reduce(function(sum,e){return sum+e.valor;},0);if(s>0)rows.push([cat.name,s]);});
  var ws=XLSX.utils.aoa_to_sheet(rows);
  ws['!cols']=[{wch:4},{wch:13},{wch:35},{wch:15},{wch:15},{wch:12},{wch:30}];
  XLSX.utils.book_append_sheet(wb,ws,'Despesas');
  if(deposits.length){
    var dr=[['DEP√ìSITOS RECEBIDOS'],[],['#','DATA','TIPO','VALOR (R$)','OBSERVA√á√ÉO']];
    deposits.forEach(function(d,i){dr.push([i+1,fD(d.data),d.tipo,d.valor,d.obs||'']);});
    dr.push([],[],['','','Flash',fA],['','','Dep√≥sito',dA],['','','TOTAL',fA+dA]);
    var ws2=XLSX.utils.aoa_to_sheet(dr);ws2['!cols']=[{wch:4},{wch:13},{wch:15},{wch:12},{wch:30}];
    XLSX.utils.book_append_sheet(wb,ws2,'Dep√≥sitos');
  }
  var dt=new Date().toLocaleDateString('pt-BR').replace(/\//g,'-');
  XLSX.writeFile(wb,'prestacao-contas-'+dt+'.xlsx');
  toast('‚úÖ Excel exportado!','green');
}

async function rNP(){if(!settings.notifEnabled)return;if('Notification'in window&&Notification.permission!=='granted')await Notification.requestPermission();}
function SN(title,body){
  if('Notification'in window&&Notification.permission==='granted'){new Notification(title,{body:body});}
  else{document.getElementById('nt').textContent=body;document.getElementById('nb').classList.add('show');}
}
function DN(){document.getElementById('nb').classList.remove('show');}
function tN(){SN('üçΩÔ∏è NotaF√°cil','Notifica√ß√£o de teste ‚Äî funcionando!');toast('Notifica√ß√£o enviada!');}
function chkN(){
  if(!settings.notifEnabled)return;
  var now=new Date();var h=now.getHours(),m=now.getMinutes();
  var key='nf_notif_'+now.toDateString();
  var fired=JSON.parse(localStorage.getItem(key)||'{}');
  var today=now.toISOString().split('T')[0];
  if(h===12&&m<6&&!fired.lunch){
    if(!expenses.filter(function(e){return e.data===today&&e.categoria==='Alimenta√ß√£o';}).length){
      SN('üçΩÔ∏è Hora do Almo√ßo!','Lembre-se de fotografar e registrar a nota do almo√ßo.');
      fired.lunch=true;localStorage.setItem(key,JSON.stringify(fired));
    }
  }
  if(h===19&&m<6&&!fired.dinner){
    if(expenses.filter(function(e){return e.data===today&&e.categoria==='Alimenta√ß√£o';}).length<2){
      SN('üåô Hora da Janta!','N√£o esque√ßa de registrar a nota da janta!');
      fired.dinner=true;localStorage.setItem(key,JSON.stringify(fired));
    }
  }
}

function toast(msg,type){
  var t=document.getElementById('toast');t.textContent=msg;t.className='toast '+(type||'');
  setTimeout(function(){t.classList.add('show');},10);
  setTimeout(function(){t.className='toast';},2800);
}

ld();rH();rNP();
setInterval(chkN,60000);chkN();

if('serviceWorker' in navigator){
  window.addEventListener('load',function(){
    navigator.serviceWorker.register('./sw.js')
      .then(function(){console.log('SW ok');})
      .catch(function(e){console.log('SW err',e);});
  });
}

// GEMINI KEY MANAGEMENT
function saveGeminiKey(){
  var k=(document.getElementById('geminiKeyInput')||{value:''}).value.trim();
  if(k.length<10){toast('Chave inv√°lida','red');return;}
  localStorage.setItem('nf_gemini_key',k);
  updateGeminiKeyStatus();
  var b=document.getElementById('apiSetupBanner');
  if(b)b.style.display='none';
  toast('‚úÖ Chave Gemini salva!','green');
}
function saveGeminiKeyBanner(){
  var k=(document.getElementById('apiKeyInput')||{value:''}).value.trim();
  if(k.length<10){toast('Chave inv√°lida','red');return;}
  localStorage.setItem('nf_gemini_key',k);
  var b=document.getElementById('apiSetupBanner');
  if(b)b.style.display='none';
  toast('‚úÖ Chave Gemini salva!','green');
}
function updateGeminiKeyStatus(){
  var k=localStorage.getItem('nf_gemini_key')||'';
  var el=document.getElementById('geminiKeyStatus');
  if(!el)return;
  if(k){el.textContent='‚úÖ Chave configurada ‚Äî IA pronta!';el.style.color='var(--green)';}
  else{el.textContent='‚ö†Ô∏è Nenhuma chave ‚Äî IA desativada';el.style.color='var(--amber)';}
}



</script>
</body>
</html>